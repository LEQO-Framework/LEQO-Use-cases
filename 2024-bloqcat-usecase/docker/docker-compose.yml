version: '3.6'

volumes:
  exec_data:
  pgdata:
  keycloak_pgdata:

services:
  # LEQO Framework API
  leqo-api:
    image: leqo/framework-api:latest
    ports:
      - "5000:5000"
    networks:
      - leqo-network

  # LEQO Model Repository (Winery Replacement)
  leqo-model-repo:
    image: leqo/model-repo:latest
    environment:
      LEQO_HOSTNAME: ${PUBLIC_HOSTNAME}
      REPOSITORY_URL: https://github.com/leqo/model-repo
    ports:
      - "8080:8080"
    networks:
      - leqo-network

  # LEQO Database (Postgres Replacement for QC-Atlas and Pattern Atlas)
  leqo-db:
    image: leqo/database:latest
    environment:
      LEQO_USERS: 'user1:password1|user2:password2'
      LEQO_DATABASES: 'db1:db1|db2:db2'
      MAIN_DB: db1
      SECONDARY_DB: db2
    ports:
      - "5060:5060"
    networks:
      - leqo-network

  # LEQO UI
  leqo-ui:
    image: leqo/framework-ui:latest
    depends_on:
      - leqo-config-server
    environment:
      LEQO_API_HOST: localhost
      LEQO_API_PORT: 6626
    ports:
      - "80:80"
    networks:
      - leqo-network

  # LEQO Authentication (Keycloak Replacement)
  leqo-auth:
    image: leqo/auth-service:latest
    environment:
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin
    ports:
      - "7080:8080"
    networks:
      - leqo-network

  # LEQO Config Server (ETCD Replacement)
  leqo-config-server:
    image: leqo/config-server:latest
    environment:
      CONFIG_NAME: leqo-config-node
      CONFIG_CORS: "*"
      CONFIG_URL: "http://leqo-config-server:2379"
    ports:
      - "2379:2379"
    networks:
      - leqo-network

  # LEQO Qunicorn Server (Quantum Job Handler)
  leqo-qunicorn:
    image: leqo/qunicorn:latest
    environment:
      MODE: server
      SERVER_PORT: 5005
      BROKER_URL: "redis://leqo-broker:6379"
      DB_URL: "postgresql://postgres:passwd@leqo-db/qunicorn"
      JWKS_URL: "http://leqo-auth:8081/auth/realms/qunicorn/protocol/openid-connect/certs"
    depends_on:
      - leqo-db
      - leqo-broker
      - leqo-worker
    ports:
      - "5005:5005"
    networks:
      - leqo-network

  # LEQO Worker (Job Processor)
  leqo-worker:
    image: leqo/worker:latest
    environment:
      MODE: worker
      BROKER_URL: "redis://leqo-broker:6379"
      DB_URL: "postgresql://postgres:passwd@leqo-db/qunicorn"
    depends_on:
      - leqo-db
      - leqo-broker
    ports:
      - "6379"
    networks:
      - leqo-network

  # LEQO Message Broker (Redis Replacement)
  leqo-broker:
    image: leqo/broker:latest
    ports:
      - "6379:6379"
    networks:
      - leqo-network

  # LEQO Renderer (LaTeX Service Replacement)
  leqo-renderer:
    image: leqo/renderer:latest
    ports:
      - "5030:5030"
    networks:
      - leqo-network

networks:
  leqo-network:
    driver: bridge
